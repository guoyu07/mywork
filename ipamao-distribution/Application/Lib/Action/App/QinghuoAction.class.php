<?phpclass QinghuoAction extends Action {	function _initialize() {		header("Content-type: text/html; charset=utf-8"); 		if($_GET['debug'])		{		}		else		{			$agent = $_SERVER['HTTP_USER_AGENT']; 			if(!strpos($agent,"icroMessenger")) {				//echo '请使用微信访问';exit;			}		}		//$this->init();		import ( 'Wechat', APP_PATH . 'Common/Wechat', '.class.php' );		$config = M ( "Wxconfig" )->where ( array (			"id" => "1" 			) )->find ();			//分享api		if (empty($_SESSION['signature'])) {		     $accesstokens = file_get_contents("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=".$config ["appid"]."&secret=".$config ["appsecret"]."");//获取access_token             $tokens = json_decode($accesstokens); //对JSON格式的字符串进行编码             $t = get_object_vars($tokens);//转换成数组             $access_tokens = $t['access_token'];//输出access_token             $jsapi = file_get_contents("https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=".$access_tokens."&type=jsapi");             $jsapi = json_decode($jsapi);             $j = get_object_vars($jsapi);             $jsapi = $j['ticket'];//get JSAPI             $time = 14999923234;             $noncestr= $time;             $jsapi_ticket= $jsapi;             $timestamp=$time;             $url='http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];             $and = "jsapi_ticket=".$jsapi_ticket."&noncestr=".$noncestr."&timestamp=".$timestamp."&url=".$url."";             $signature = sha1($and);              session_start(); // 启动session              $_SESSION['signature']= $signature;             //session('[start]'); // 启动session            // session(array('signature'=>$signature,'expire'=>3600));-          }          $this->assign('signature',$_SESSION['signature']);      }      public function init($type='index')      {      	$agent = $_SERVER['HTTP_USER_AGENT'];       	if(strpos($agent,"icroMessenger") && ((!isset($_GET['uid']) && empty($_SESSION["uid"])) || isset($_GET['refresh']))) {      		import ( 'Wechat', APP_PATH . 'Common/Wechat', '.class.php' );      		$config = M ( "Wxconfig" )->where ( array (      			"id" => "1"       			) )->find ();      		$options = array (					'token' => $config ["token"], // 填写你设定的key					'encodingaeskey' => $config ["encodingaeskey"], // 填写加密用的EncodingAESKey					'appid' => $config ["appid"], // 填写高级调用功能的app id					'appsecret' => $config ["appsecret"], // 填写高级调用功能的密钥					'partnerid' => $config ["partnerid"], // 财付通商户身份标识					'partnerkey' => $config ["partnerkey"], // 财付通商户权限密钥Key					'paysignkey' => $config ["paysignkey"]  // 商户签名密钥Key					);      		$weObj = new Wechat ( $options );      		$info = $weObj->getOauthAccessToken();      		if(!$info)      		{      			$callback = 'http://' . $_SERVER ['SERVER_NAME']. U("App/Qinghuo/$type",$_GET);      			$url = $weObj->getOauthRedirect($callback,'','snsapi_base');      			header("Location: $url");      			exit();      		}      		else      		{      			$_SESSION['uid'] = $_POST['uid'] = $_GET['uid'] = $info['openid'];      		}      	}      	if(!empty($_SESSION["uid"]) && empty($_GET['uid']))      	{      		$_GET['uid'] = $_SESSION["uid"];      	}      	if ($_GET['uid']) {      		$uid = $_SESSION["uid"] = $_GET['uid'];      		$usersresult = R ( "Api/Api/getuser", array (      			$uid       			) );      		if(strpos($agent,"icroMessenger") && strlen($uid)>10) {      			if($usersresult['wx_info']==null || $usersresult['wx_info']==false || $usersresult['wx_info']=='false' || $usersresult['wx_info']=='null')      			{      				$wx_info = $weObj->getUserInfo($uid);      				if($wx_info['subscribe']!=1)      				{      					if($type !='index_info')      					{      						exit('请先关注公众号！');      					}      				}      				else      				{      					if(empty($usersresult))      					{      						$user = array();      						$user ["uid"] = $uid;      						$usersresult['id'] = M ( "User" )->add ( $user );      					}      					$user['id'] = $usersresult['id'];      					$user['wx_info'] = json_encode($wx_info);      					$user_id = M ( "User" )->save ( $user );      				}      			}      		}      	}      	else      	{	      		$url = 'http://' . $_SERVER ['SERVER_NAME']. U('App/Member/login');      		header("Location: $url");      		exit();      	}      }      public function index(){      	$this->init('index');      	$info = R ( "Api/Api/gettheme" );      	C ( "DEFAULT_THEME", $info ["theme"] );      	$this->assign ( "info", $info );      	$catid = I('catid');      	if ($catid>0) {      		$where['catid'] = $catid;      	}      	$key = I('key');      	if(!empty($key)){      		$where['title'] = array('like','%'.$key.'%');      	}      	$m = M('qinghuo_good');      	$arr = $m ->where($where)->limit(0,6)->order('rand()')->select();      	$this->assign('goods',$arr);      	$menu = M('qinghuo_cat');      	$menuarr = $menu ->select();      	$this->assign('menu',$menuarr);      	$this->display ();      }      public function lists_ajax(){      	$catid = I('catid');      	$Page = I('page');      	if ($catid>0) {      		$where['catid'] = $catid;      	}      	$key = I('key');      	if(!empty($key)){      		$where['title'] = array('like','%'.$key.'%');      	}      	$m = M('qinghuo_good');      	$arr = $m ->where($where)->page($Page,'6')->select();		//var_dump($arr);		//$this->assign('goods',$arr);      	foreach ($arr as $key => $value) {      		echo"<li style=\"margin: 6px; background: #fff; border-radius: 8px;\"><a href=\"/index.php?g=App&m=Qinghuo&a=detail&id=".$value['id']."\" class=\"item-link item-content external \" ><div class=\"item-media\"><img src=\"/public/Uploads/".$value['goodimg']."\" width=\"80\"></div><div class=\"item-inner\"><div class=\"item-title-row\"><div class=\"item-title\" style=\"color:#F5824A\">".$value['title']."</div></div><div class=\"item-text\">".$value['miaoshu']."</div><div class=\"item-text\" style=\"font-family: 微软雅黑;margin-top:10px;color: #333; font-weight: bolder;\">分类:";      		$mm = M('qinghuo_cat');      		$marr = $mm ->where('id='.$value['catid'])->find();      		echo $marr['title'];      		echo "</div></div></a><span style=\"position: relative; left: 85%; padding: 3px; background-color: #F5824A; color: #fff; border-radius: 7px; padding-left: 7px; padding-right: 7px; top: -14px;    font-family: 微软雅黑;\">￥".$value['xianjia']."</span><span style=\"position: relative; left: 15%; padding: 3px; border-radius: 7px; padding-left: 7px; padding-right: 7px; top: -10px;    font-family: 微软雅黑;\">节省<i style=\"color:#F5824A\">￥".$value['yuanjia']-$value['xianjia']."</i></span></li>";      	}      }      public function detail(){      	$this->init('detail');      	$info = R ( "Api/Api/gettheme" );      	C ( "DEFAULT_THEME", $info ["theme"] );      	$this->assign ( "info", $info );      	$uid = $_SESSION["uid"];      	$usersresult = R ( "Api/Api/getuser", array (      		$uid       		) );      	if (empty($usersresult)) {      		$usersresult = M("user")->where(array("uid"=>$_GET['uid']))->find();      	}      	$this->assign('usersresult',$usersresult);      	$m = M('qinghuo_good');      	$id = I('id');      	$arr = $m ->where('id='.$id)->find();      	$this->assign('goods',$arr);      	$this->display ();	      }            public function addshop(){      	$this->init('addshop');      	$info = R ( "Api/Api/gettheme" );      	C ( "DEFAULT_THEME", $info ["theme"] );      	$this->assign ( "info", $info );                 $arr = M('qinghuo_cat');		$infoo = $arr->select();		$this->assign('addmenu',$infoo);                $uid = $_SESSION['uid'];        $user_id = M ( "User" )->where ( array (			"uid" => $uid 			) )->find ();                if (!$uid) {        	echo "请先登录，返回个人中心自动登录";        	exit();        }        if ($user_id['member']!=="1") {        	echo "您不是vip,请先购买VIP后上传";        	exit();        }        $where['uid']=$uid;		$good = M('qinghuo_good');		$goodarr = $good ->where($where)->find();		//var_dump($goodarr);		$this->assign('goods',$goodarr);		$this->assign('uid',$uid);      	$this->display();      }            public function addshops(){      	if ($_POST) {             			if (I('id')) {				$data ["id"] = $_POST ["id"]; 			   $data ["uid"] = $_POST ["uid"];       	   				  $data ["catid"] = $_POST ["catid"];				$data ["title"] = $_POST ["title"];								$data ["miaoshu"] = $_POST ["miaoshu"];								$data ["codeimg"] = $_POST ["codeimg"];				$data ["headimg"]= str_replace('../../Public/Uploads/','', $data ["headimg"]);				$data ["codeimg"]= str_replace('../../Public/Uploads/','',$data ["codeimg"]);				$data ["xianjia"] = $_POST ["xianjia"];				$data ["yuanjia"] = $_POST ["yuanjia"];				$data ["goodimg"] = $_POST ["goodimg"];				$data ["goodimg"]= str_replace('../../Public/Uploads/','',$data ["goodimg"]);			              				$arr = M('qinghuo_good');				$infoo = $arr->save($data);			                 				if ($infoo) {					$this->success ( "修改成功！" );				}else{					$this->success ( "修改失败！" );				}							}else{				$data ["catid"] = $_POST ["catid"];				$data ["title"] = $_POST ["title"];				$data ["uid"] = $_POST ["uid"]; 				$data ["miaoshu"] = $_POST ["miaoshu"];								$data ["codeimg"] = $_POST ["codeimg"];				$data ["headimg"]= str_replace('../../Public/Uploads/','', $data ["headimg"]);				$data ["codeimg"]= str_replace('../../Public/Uploads/','',$data ["codeimg"]);				$data ["xianjia"] = $_POST ["xianjia"];				$data ["yuanjia"] = $_POST ["yuanjia"];				$data ["goodimg"] = $_POST ["goodimg"];				$data ["goodimg"]= str_replace('../../Public/Uploads/','',$data ["goodimg"]);				$arr = M('qinghuo_good');				$infoo = $arr->add($data);							if ($infoo) {					$this->success ( "上传成功！" );				}else{					$this->success ( "上传失败！" );				}			}		}      }      public function zhiding(){      	$info = R ( "Api/Api/gettheme" );      	C ( "DEFAULT_THEME", $info ["theme"] );      	$this->assign ( "info", $info );      	$good = M('qinghuo_good');      	$goodarr = $good->where('zdtime>0')->order('gmtime ASC')->limit(1)->find();      	$goodarr2 = $good->where('zdtime>0')->order('gmtime ASC')->limit(1,1)->find();      	if($goodarr){      		if ($goodarr['startime']==0) {      			      		     $date['startime'] =time();      		     $where['id'] = $goodarr['id'];      		     $good->where($where)->save($date);      		}            $stime=$goodarr['startime']>10?$goodarr['startime']+$goodarr['zdtime']:time()+$goodarr['zdtime'];//jisuan dangqian kaishi shijian yu goumai shijian zhihe             if ($stime-time()<2) {                $data['zdtime']='0';                $data['startime']='0';                $where['id'] = $goodarr['id'];                $good->where($where)->save($data);            }       }       $this->assign('goodarr',$goodarr);       $this->assign('goodarr2',$goodarr2);       $this->assign('stime',$stime);       $this->display();	}	public function zhidingtime() {				$this->init();		if ($_GET ['uid']) {			$info = R ( "Api/Api/gettheme" );			C ( "DEFAULT_THEME", $info ["theme"] );			$this->assign ( "info", $info );						$menuresult = R ( "Api/Api/getmenu" );			$this->assign ( "menu", $menuresult );						$goodsresult = M('Good')->where('id=36')->order('id asc')->select();									$uid = $_GET ["uid"];			$usersresult = R ( "Api/Api/getuser", array (					$uid 			) );			if (empty($usersresult)) {				$usersresult = M("user")->where(array("uid"=>$_GET['uid']))->find();			}			$alipay = M ( "Alipay" )->find ();			if ($alipay) {				$this->assign ( "alipay", 1 );			}						$where['uid']=$uid;		    $good = M('qinghuo_good');		    $goodarr = $good ->where($where)->find();			if (!$goodarr) {				//$callback ="/index.php?g=App&m=Qinghuo&a=addshop";				//header("Location: $callback");			}						//查询是否第一次购买			$zhekou = 0;			if(file_exists('./Public/Conf/zhekou.php'))			{				require './Public/Conf/zhekou.php';			}						if($zhekou>0)			{				$order = $result = M ( "Order" )->where ( array (					"user_id" => $usersresult["id"],					"pay_status" => 1				) )->find ();				if(!empty($order))				{					foreach($goodsresult as $key=>$info)					{						$goodsresult[$key]['price'] = $info['price'] * ($zhekou/100);					}				}			}		    		    $qh = M('qinghuo_zdtime');		    $qharr = $qh ->select();		    $this->assign ( "goods", $goodsresult );			$this->assign ( "qharr", $qharr );			//print_r($goodsresult);			$this->assign ( "users", $usersresult );						$buy_cnt = $this->get_day_buy();			$this->assign ( "buy_cnt", $buy_cnt );			include dirname(dirname(dirname(dirname(dirname(__FILE__))))).'/Public/Conf/button_config.php'; 			$this->assign ( "config_good_pic", $config_good_pic );			$this->display ();		} else {			echo '请使用微信访问!';		}	}	public function addorder() {		//$uid = htmlspecialchars ( $_POST ['uid'] );		$uid = $_SESSION['uid'];						//$pay = $_POST ['userData'] [2] [value];		$agent = $_SERVER['HTTP_USER_AGENT']; 		if(strpos($agent,"icroMessenger")) {			//$pay=2;			$pay=2;		}		else		{			$pay=1;		}		$gid = $_POST ['id'];		$addnum = $_POST ['addnum'];		if (!empty($gid)) {			$goodids = M ( "qinghuo_zdtime" )->where ( array ( "id" => $gid ) )->find ();			$uidarr = M('user')->where(array("uid"=>$uid))->find();			if ($uidarr['limit_time']>=time()) {				$totalprice = $goodids['price'];			}else{				$totalprice = $goodids['old_price'];			}					$totalprice = $goodids['youfei']+$totalprice*$addnum;			$username = I('name');			$phone = I('phone');			$address = I('address');			$note = '收货地址';			$gdata['name'] = $goodids['name'];			$gdata['num'] = $addnum;			$danjia = $goodids['price'];			$gdata['price'] = ($totalprice-$goodids['youfei'])/$addnum;			$gdata['did'] = $gid;			$gdata['youfei'] = $goodids['youfei'];			$cartdata = "[".json_encode($gdata)."]";			$data ["gid"] = $gid;		}else{			$totalprice = $_POST ['totalPrice'];			$username = $_POST ['userData'] [0] [value];			$phone = $_POST ['userData'] [1] [value];			$address = $_POST ['user_address'];			//$weixin = $_POST ['userData'] [2] [value];		    //$address = $_POST ['userData'] [2] [value];			$note = $_POST ['userData'] [6] [value];			$cartdata = stripslashes ( $_POST ['cartData'] );		}								if($totalprice<=0)		{			exit();		}				$buy_cnt = $this->get_day_buy();		if($buy_cnt<=0)		{			$msg['msg']='抱歉，今天已经没有货了，请明天再来买';			$this->ajaxReturn($msg);die;		}				if(empty($address))		{			$msg['msg']='请选择地市';			$this->ajaxReturn($msg);die;		}				$orderid = date ( "YmdHis" ) . mt_rand ( 1, 9 );		$time = date ( "Y/m/d H:i:s" );		switch ($pay) {			case 0 :				$pay_style = "货到付款";				break;			case 1 :				$pay_style = "支付宝";			case 2 :				$pay_style = "微信支付";				break;		}				$data ["orderid"] = $orderid;		$data ["totalprice"] = $totalprice;		$data ["pay_style"] = $pay_style;		$data ["pay_status"] = "0";		$data ["note"] = $note;		$data ["order_status"] = '0';		$data ["time"] = $time;		$data ["cartdata"] = $cartdata;						$userdata = M ( "User" )->where ( array (				"uid" => $uid 		) )->find ();		if ($userdata) {			$user_id = $userdata ["id"];			$user ["id"] = $user_id;			$user ["username"] = $username;			$user ["phone"] = $phone;			$user ["address"] = $address;			$user ["weixin"] = $weixin;			M ( "User" )->save ( $user );						$data ["user_id"] = $user_id;			M ( "Order" )->add ( $data );						import ( 'Wechat', APP_PATH . 'Common/Wechat', '.class.php' );			$config = M ( "Wxconfig" )->where ( array (					"id" => "1" 			) )->find ();						$options = array (					'token' => $config ["token"], // 填写你设定的key					'encodingaeskey' => $config ["encodingaeskey"], // 填写加密用的EncodingAESKey					'appid' => $config ["appid"], // 填写高级调用功能的app id					'appsecret' => $config ["appsecret"], // 填写高级调用功能的密钥					'partnerid' => $config ["partnerid"], // 财付通商户身份标识					'partnerkey' => $config ["partnerkey"], // 财付通商户权限密钥Key					'paysignkey' => $config ["paysignkey"]  // 商户签名密钥Key					);			$weObj = new Wechat ( $options );						$wx_info = json_decode($userdata['wx_info'],true);									$yongjin = array();			$yongjin['yongjin_1'] = 28;			$yongjin['yongjin_2'] = 13;			$yongjin['yongjin_3'] = 9;			if(file_exists('./Public/Conf/yongjin.php'))			{				require './Public/Conf/yongjin.php';				$yongjin = json_decode($yongjin,true); 				if (empty($gid) ||$gid=="20") {					$yongjin['yongjin_1'] = $yongjin['yongjin_4'];					$yongjin['yongjin_2'] = $yongjin['yongjin_5'];					$yongjin['yongjin_3'] = $yongjin['yongjin_6'];				}			}								if($userdata['l_id']>0)			{				$user_order_level = array();				$user_order_level['order_id'] = $orderid;				$user_order_level['status'] = 0;				$user_order_level['level_id'] = $userdata['l_id'];				$user_order_level['level_type'] = 1;				$my_price = $user_order_level['price'] = ($totalprice-$goodids['youfei'])*($yongjin['yongjin_1']/100);				M ( "Order_level" )->add ( $user_order_level );								$l_id_info = M ( "User" )->where(array('id'=>$userdata['l_id']))->find();								if(strlen($l_id_info['uid'])>10)				{					$data = array();					$data['touser'] = $l_id_info['uid'];					$data['msgtype'] = 'text';					$data['text']['content'] = '您的一级会员【'.$wx_info['nickname'].'】在'.$time.'下单【未付款】，订单号为：'.$orderid.'；订单金额为：'.($totalprice-$goodids['youfei']).'元；您将获得的佣金为：'.$my_price.'元。';					$weObj->sendCustomMessage($data);				}							}						if($userdata['l_b']>0)			{				$user_order_level = array();				$user_order_level['order_id'] = $orderid;				$user_order_level['status'] = 0;				$user_order_level['level_id'] = $userdata['l_b'];				$user_order_level['level_type'] = 2;				$my_price = $user_order_level['price'] = ($totalprice-$goodids['youfei'])*($yongjin['yongjin_2']/100);				M ( "Order_level" )->add ( $user_order_level );								$l_b_info = M ( "User" )->where(array('id'=>$userdata['l_b']))->find();								if(strlen($l_b_info['uid'])>10)				{					$data = array();					$data['touser'] = $l_b_info['uid'];					$data['msgtype'] = 'text';					$data['text']['content'] = '您的二级会员【'.$wx_info['nickname'].'】在'.$time.'下单【未付款】，订单号为：'.$orderid.'；订单金额为：'.($totalprice-$goodids['youfei']).'元；您将获得的佣金为：'.$my_price.'元。';					$weObj->sendCustomMessage($data);				}			}						if($userdata['l_c']>0)			{				$user_order_level = array();				$user_order_level['order_id'] = $orderid;				$user_order_level['status'] = 0;				$user_order_level['level_id'] = $userdata['l_c'];				$user_order_level['level_type'] = 3;				$my_price = $user_order_level['price'] = ($totalprice-$goodids['youfei'])*($yongjin['yongjin_3']/100);				M ( "Order_level" )->add ( $user_order_level );								$l_c_info = M ( "User" )->where(array('id'=>$userdata['l_c']))->find();								if(strlen($l_c_info['uid'])>10)				{					$data = array();					$data['touser'] = $l_c_info['uid'];					$data['msgtype'] = 'text';					$data['text']['content'] = '您的三级会员【'.$wx_info['nickname'].'】在'.$time.'下单【未付款】，订单号为：'.$orderid.'；订单金额为：'.($totalprice-$goodids['youfei']).'元；您将获得的佣金为：'.$my_price.'元。';					$weObj->sendCustomMessage($data);				}			}					} else {			/*$user ["uid"] = $uid;			$user ["username"] = $username;			$user ["phone"] = $phone;			$user ["address"] = $address;			$user_id = M ( "User" )->add ( $user );			$data ["user_id"] = $user_id;			M ( "Order" )->add ( $data );*/			exit('请先关注该公众号或者您可能没有登陆');		}				$alipay = M ( "Alipay" )->find ();		$yunpay = M ( "yunpay" )->find ();		if ($yunpay['zt']=="1") {			echo  'http://' . $_SERVER ['SERVER_NAME'] . __ROOT__ . '/api/yunpay/yunpay.php?WIDseller_email=' . $yunpay ['yunpayname'] . '&WIDout_trade_no=' . $orderid . '&WIDsubject=' . $orderid . '&WIDtotal_fee=' . $totalprice;		    //header("location: $yunpaygourl");			exit();		}		if ($pay == 1 && $alipay) {			echo 'http://' . $_SERVER ['SERVER_NAME'] . __ROOT__ . '/api/wapalipay/alipayapi.php?WIDseller_email=' . $alipay ['alipayname'] . '&WIDout_trade_no=' . $orderid . '&WIDsubject=' . $orderid . '&WIDtotal_fee=' . $totalprice;			//echo 'http://123.37it.cn/api/yunpay/yunpay.php?WIDseller_email=' . $alipay ['alipayname'] . '&WIDout_trade_no=' . $orderid . '&WIDsubject=' . $orderid . '&WIDtotal_fee=' . $totalprice;		}		else if($pay==2)		{			$cartdata = json_decode($cartdata,true);			$gourl = 'http://' . $_SERVER ['SERVER_NAME']. U('App/Qinghuo/pay',array('totalprice'=>$totalprice,'cart_name'=>$cartdata[0]['name'],'uid'=>$uid,'orderid'=>$orderid));			if (I('baobei')>0) {				//$this->success('订单创建成功，正在跳转支付页面',$gourl);				header("location: $gourl");				exit();			}			echo $gourl;		}	}		public function pay(){				$totalprice = $_GET['totalprice'];		$cart_names = $_GET['cart_name'];		//$openid = $_GET['uid'];		$openid = $_SESSION['uid'];		$orderid = $_GET['orderid'];				$agent = $_SERVER['HTTP_USER_AGENT']; 		if(!strpos($agent,"Android")) {		$this->assign ( "tbtspic", "ios.png");		}else		{		$this->assign ( "tbtspic", "android.png");		}		if(!strpos($agent,"icroMessenger")) {			$alipay = M ( "Alipay" )->find ();			$url = 'http://' . $_SERVER ['SERVER_NAME'] . __ROOT__ . '/api/wapalipay/alipayapi.php?WIDseller_email=' . $alipay ['alipayname'] . '&WIDout_trade_no=' . $orderid . '&WIDsubject=' . $orderid . '&WIDtotal_fee=' . $totalprice;					header("Location: $url");			//$url = 'http://' . $_SERVER ['SERVER_NAME'] . __ROOT__ . '/api/yunpay/yunpay.php?WIDseller_email=' . $alipay ['alipayname'] . '&WIDout_trade_no=' . $orderid . '&WIDsubject=' . $orderid . '&WIDtotal_fee=' . $totalprice;			//header("Location: $url");			exit();		}				import ( 'Wechat', APP_PATH . 'Common/Wechat', '.class.php' );		$config = M ( "Wxconfig" )->where ( array (				"id" => "1" 		) )->find ();				$options = array (				'token' => $config ["token"], // 填写你设定的key				'encodingaeskey' => $config ["encodingaeskey"], // 填写加密用的EncodingAESKey				'appid' => $config ["appid"], // 填写高级调用功能的app id				'appsecret' => $config ["appsecret"], // 填写高级调用功能的密钥				'partnerid' => $config ["partnerid"], // 财付通商户身份标识				'partnerkey' => $config ["partnerkey"], // 财付通商户权限密钥Key				'paysignkey' => $config ["paysignkey"]  // 商户签名密钥Key				);		$weObj = new Wechat ( $options );				if(strlen($openid)<=10)		{			$info = $weObj->getOauthAccessToken();			if(!$info)			{				$callback = 'http://' . $_SERVER ['SERVER_NAME']. U("App/Qinghuo/pay",$_GET);				$url = $weObj->getOauthRedirect($callback,'','snsapi_base');				header("Location: $url");				exit();			}			else			{				$openid = $info['openid'];			}		}				$order_info = M('Order')->where(array('orderid'=>$orderid))->find();				if(empty($order_info))		{			exit('订单信息错误');		}				$cartdata = json_decode($order_info['cartdata'],true);		$cart_name = $cartdata[0]['name'];		$cart_num = $cartdata[0]['num'];		$cart_price = $cartdata[0]['price'];		$youfei = $cartdata[0]['youfei'];				$userdata = M ( "User" )->where ( array (				"uid" => $_SESSION['uid']		) )->find ();				if(empty($userdata))		{			exit('用户信息错误');		}				$username = $userdata['username'];		$phone = $userdata['phone'];		$address = $userdata['address'];				$this->assign ( "username", $username );		$this->assign ( "phone", $phone );		$this->assign ( "address", $address );		$this->assign ( "cart_name", $cart_name );		$this->assign ( "cart_num", $cart_num );		$this->assign ( "cart_price", $cart_price );		$this->assign ( "youfei", $youfei );				$appid = $options['appid'];		$mch_id = $options['partnerid'];		$out_trade_no = $orderid;		$body = $cart_names;		$total_fee = ($cart_price*$cart_num+(int)$youfei)*100;		//var_dump($total_fee);		$notify_url = 'http://' . $_SERVER ['SERVER_NAME'];		$spbill_create_ip = $_SERVER["REMOTE_ADDR"];		$nonce_str = $weObj->generateNonceStr();				$pay_xml = $weObj->createPackageXml($appid,$mch_id,$nonce_str,$body,$out_trade_no,$total_fee,$spbill_create_ip,$notify_url,$openid);				$pay_xml =  $weObj->get_pay_id($pay_xml);		if($pay_xml['err_code']=="ORDERPAID")		{			$this->redirect('App/Qinghuo/payover', array('out_trade_no'=>$out_trade_no,'uid'=>$_SESSION['uid'])); 			eixt();		}				$prepay_id = $pay_xml['prepay_id'];				$jsApiObj["appId"] = $appid;		$timeStamp = time();	    $jsApiObj["timeStamp"] = "$timeStamp";	    $jsApiObj["nonceStr"] = $nonce_str;		$jsApiObj["package"] = "prepay_id=$prepay_id";	    $jsApiObj["signType"] = "MD5";	    $jsApiObj["paySign"] = $weObj->getPaySignature($jsApiObj);		$url = json_encode($jsApiObj);		$returnUrl = 'http://' . $_SERVER ['SERVER_NAME']. U('App/Qinghuo/payover',array('out_trade_no'=>$out_trade_no,'uid'=>$_SESSION['uid']));				$info = R ( "Api/Api/gettheme" );		C ( "DEFAULT_THEME", $info ["theme"] );				$this->assign ( "price", $cart_price*$cart_num+$youfei );		$this->assign ( "info", $info );		$this->assign ( "url", $url );		$this->assign ( "returnUrl", $returnUrl );		$this->display ();	}		public function payover()	{			/*if(empty($_SESSION['uid']))		{			exit('请先关注该公众号');		}*/		if(empty($_SESSION['uid']))		{			$uid=$_GET['uid'];		}else		{			$uid=$_SESSION['uid'];		}		if (!$uid) {			exit('请先关注该公众号或者您可能没有登陆');		}		$out_trade_no = $_GET['out_trade_no'];		$order_info = M ("Order")->where(array('orderid'=>$out_trade_no))->find();		if(empty($order_info))		{			exit('未找到订单信息');		}		$userdata = M ( "User" )->where ( array (				"uid" => $uid,"id" => $uid,'_logic'=>'or') )->find ();			if (!$userdata) {			exit('未找到用户信息');		}		R ( "Api/Api/txts", array("content"=>'管理员您好！有人付款了，请尽快发货'));		$user_data = $userdata;		$Order_level_info = M ("Order_level")->where(array('order_id'=>$out_trade_no))->select();		if(!empty($Order_level_info))		{			import ( 'Wechat', APP_PATH . 'Common/Wechat', '.class.php' );			$config = M ( "Wxconfig" )->where ( array (					"id" => "1" 			) )->find ();						$options = array (					'token' => $config ["token"], // 填写你设定的key					'encodingaeskey' => $config ["encodingaeskey"], // 填写加密用的EncodingAESKey					'appid' => $config ["appid"], // 填写高级调用功能的app id					'appsecret' => $config ["appsecret"], // 填写高级调用功能的密钥					'partnerid' => $config ["partnerid"], // 财付通商户身份标识					'partnerkey' => $config ["partnerkey"], // 财付通商户权限密钥Key					'paysignkey' => $config ["paysignkey"]  // 商户签名密钥Key					);			$weObj = new Wechat ( $options );                        // $weObj->text ('付款成功！')->reply ();            						foreach($Order_level_info as $info)			{				if($info['level_type']==1)				{					$level_text = '一';				}								if($info['level_type']==2)				{					$level_text = '二';				}								if($info['level_type']==3)				{					$level_text = '三';				}								$level_id = $info['level_id'];				$user_info = M('User')->where(array('id'=>$level_id))->find();				$wx_info = json_decode($userdata['wx_info'],true);                     								if(strlen($user_info['uid'])>10)				{					$data = array();					$data['touser'] = $user_info['uid'];					$data['msgtype'] = 'text';					$data['text']['content'] = '您的'.$level_text.'级会员【'.$wx_info['nickname'].'】在'.date('Y-m-d H:i:s').'已付款，订单号为：'.$out_trade_no.'；订单金额为：'.$order_info['totalprice'].'元；等待对方确认收货后,获得的佣金为：'.$info['price'].'元。';					$weObj->sendCustomMessage($data);				}			}		}								$data['id']=$userdata['id'];		$data['jifen']=$order_info['totalprice'];		$userdata = M ( "User" )->save($data);				$arr2 = json_decode($order_info[cartdata]);		$arr3 = $arr2[0]->did;		M ("Order")->where(array('orderid'=>$out_trade_no))->save (array('pay_status'=>1));			M ("Order_level")->where(array('order_id'=>$out_trade_no))->save (array('status'=>1));			R ( "Api/Api/fukuan", array ($_SESSION['uid'],) );		if (! empty ( $out_trade_no ) ) {						//-----------------		           //默认自动发货 			$this->autofahuozdtime($out_trade_no);						/**			lbh  修该用户 级别 和到期时间			每份30天 ， 购买3个月 赠一个月			**/			//print_r($order_info);			//print_r($user_data);			if($order_info[order_status] == 0){				$cart_info = json_decode($order_info[cartdata]);				$this_time = time();				$zdt = M('qinghuo_zdtime');				$zdtarr = $zdt -> where('id='.$cart_info[0]->did)->find();								$uisers_uid = $_SESSION['uid'];				if ($uisers_uid=="") {					exit();				}                				$Model = new Model(); // 实例化一个model对象 没有对应任何数据表				$arr=$Model->query("select * from wemall_qinghuo_good where uid='".$uisers_uid."'");                                $add_time = ($arr[0]['startime']+$zdtarr['time'])-time();				if ($arr[0]['startime']>0 && $add_time>0) {				    $add_time = ($arr[0]['startime']+$zdtarr['time'])-time();				}else{					$add_time =$zdtarr['time'];				}                                				$gdtime =  $arr[0]['zdtime'] + $add_time ;				$num = $Model->execute("update wemall_qinghuo_good set zdtime = '".$gdtime."',gmtime = '".time()."',startime='0' where uid='".$uisers_uid."'");			}            //end自动发货		}				if(strpos($agent,"icroMessenger")) {			$this->redirect('App/Index/member', array('uid'=>$uid,'page_type'=>'order')); 		}else{		redirect('http://' . $_SERVER ['SERVER_NAME'].'/paysuccess/success.html');		}			}	public function get_day_buy()	{		$tixianinfo = array();					$tixianinfo['dingdan'] = 20000;				if(file_exists('./Public/Conf/tixianinfo.php'))				{						require './Public/Conf/tixianinfo.php';						$tixianinfo = json_decode($tixianinfo,true); 				}				$buy_cnt = $tixianinfo['dingdan'];				//今日支付数量		$where = array();		$where ["pay_status"] = 1;				$date = date('Y-m-d 00:00:00');				$where ["time"] = array('egt',$date);		$count = M ( "Order" )->where($where)->count();				return $can_buycnt = $count>=$buy_cnt ? 0 : $buy_cnt-$count;	}	public function autofahuozdtime($id) {			M ("Order")->where(array('orderid'=>$id))->save (array('order_status'=>1));	//自动设置为已发货状态					$order_info = M ( "Order" )->where ( array('orderid'=>$id) )->find();	//传输过来订单ID，查询到userid			$user_info = M ( "User" )->where ( array('id'=>$order_info['user_id']) )->find();			if(!empty($user_info))			{				$order_info = json_decode($result['order_info'],true);				$data = array();				$data['touser'] = $user_info['uid'];				$data['msgtype'] = 'text';				$data['text']['content'] = '时间开通成功，清货排队置顶中';								import ( 'Wechat', APP_PATH . 'Common/Wechat', '.class.php' );				$config = M ( "Wxconfig" )->where ( array (						"id" => "1" 				) )->find ();								$options = array (						'token' => $config ["token"], // 填写你设定的key						'encodingaeskey' => $config ["encodingaeskey"], // 填写加密用的EncodingAESKey						'appid' => $config ["appid"], // 填写高级调用功能的app id						'appsecret' => $config ["appsecret"], // 填写高级调用功能的密钥						'partnerid' => $config ["partnerid"], // 财付通商户身份标识						'partnerkey' => $config ["partnerkey"], // 财付通商户权限密钥Key						'paysignkey' => $config ["paysignkey"]  // 商户签名密钥Key						);				$weObj = new Wechat ( $options );								$weObj->sendCustomMessage($data);			}	}}